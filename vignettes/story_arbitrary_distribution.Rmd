---
title: "Approximating an Arbitrary Survival Distribution"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    highlight: "textmate"
    css: "custom.css"
# bibliography: "example.bib"
vignette: >
  %\VignetteIndexEntry{Approximating an Arbitrary Survival Distribution}
  %\VignetteEngine{knitr::rmarkdown}
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, warning=FALSE}
library(simtrial)
library(tibble)
library(ggplot2)
library(gsDesign)
devtools::load_all()
```

## Introduction

We demonstrate how to approximate arbitrary continuous survival distibutions with piecewise exponential approximations.
This enables sample size computations for arbitrary survival models using software designed for the piecewise exponential distribution. 
Three functions in particular are demonstrated:

- `s2pwe()` translates an arbitrary survival distribution to piecewise exponential.
- `ppwe()` computes a cumulative survival distribution or its upper tail for a distribution in the form generated by `s2pwe()`.
- `pPM()` provides the cumulative survival distribution for a Poisson mixture distribution.

## Lognormal approximation

We demonstrate `s2pwe()` by approximating the lognormal distribution with piecewise exponential failure rates.
Note that when the resulting `lnormRates` is used, the final piecewise exponential `duration` is extended.
That is, we have arbitrarily approximated with 6 piecewise exponential rates for a duration of 1 unit of time (say, month) followed by a final rate which extends to infinity.

```{r}
#' Approximate survival distribution with piecewise exponential distribution
#'
#' \code{s2pwe} converts a discrete set of points from an arbitrary survival distribution
#' to a piecewise exponential approximation
#' @param times Positive increasing times at which survival distribution is provided.
#' @param survival Survival (1 - cumulative distribution function) at specified `times`
#' @section Specification:
#' \if{latex}{
#'  \itemize{
#'    \item Validate if input times is increasing positive finite numbers.
#'    \item Validate if input survival is numeric and same length as input times.
#'    \item Validate if input survival is positive, non-increasing, less than or equal to 1 and greater than 0.
#'    \item Create a tibble of inputs times and survival.
#'    \item Calculate the duration, hazard and the rate.
#'    \item Return the duration and rate by \code{s2pwe}
#'  }
#'  }
#' \if{html}{The contents of this section are shown in PDF user manual only.}#' @return A `tibble` with `duration` and 'rate'
#' @return A tibble containing the duration and rate.
#' @examples
#' # Example: arbitrary numbers
#' s2pwe(1:9,(9:1)/10)
#' # Example: lognormal
#' s2pwe(c(1:6,9),plnorm(c(1:6,9),meanlog=0,sdlog=2,lower.tail=FALSE))
#' @noRd

s2pwe <- function(times, survival){
# check input values
  # check that times are positive, ordered, unique and finite numbers
  if(!is.numeric(times)){stop("gsDesign2: times in `s2pwe()` must be increasing positive finite numbers")}
  if(!min(times) > 0){stop("gsDesign2: times in `s2pwe()` must be increasing positive finite numbers")}
  if(!max(times) < Inf){stop("gsDesign2: times in `s2pwe()` must be increasing positive finite numbers")}
  len <- length(times)
  if(!if(len>1){min(times[2:len]-times[1:(len-1)]) > 0}){stop("gsDesign2: times in `s2pwe()`must be increasing positive finite numbers")}

  # check that survival is numeric and same length as times
  if(!is.numeric(survival)){stop("gsDesign2: survival in `s2pwe()` must be numeric and of same length as times")}
  if(!length(survival) == len){stop("gsDesign2: survival in `s2pwe()` must be numeric and of same length as times")}

  # check that survival is positive, non-increasing, less than or equal to 1 and gt 0
  if(!min(survival) > 0){stop("gsDesign2: survival in `s2pwe()` must be non-increasing positive finite numbers less than or equal to 1 with at least 1 value < 1")}
  if(!max(survival) <= 1){stop("gsDesign2: survival in `s2pwe()` must be non-increasing positive finite numbers less than or equal to 1 with at least 1 value < 1")}
  if(!min(survival) < 1){stop("gsDesign2: survival in `s2pwe()` must be non-increasing positive finite numbers less than or equal to 1 with at least 1 value < 1")}
  if(len>1){
  if(!min(survival[2:len]-survival[1:(len-1)]) <= 0 ){stop("gsDesign2: survival in `s2pwe()` must be non-increasing positive finite numbers less than or equal to 1 with at least 1 value < 1")}
  }

  xx <- tibble::tibble(Times=times, Survival = survival) %>%
          mutate(duration = Times - lag(Times, default = 0),
                 H = -log(Survival),
                 rate = (H-lag(H,default=0)) / duration
                 ) %>%
          select(duration,rate)
  return(xx)
}
```

```{r, message=FALSE, warning=FALSE}
lnormRates <- s2pwe(
  times = c(1:6, 9),
  survival = plnorm(c(1:6, 9), meanlog = 0, sdlog = 2, lower.tail = FALSE)
)
lnormRates
```

We compare the resulting approximation to the actual lognormal survival using `ppwe()` to compute survival probabilities $P\{T>t\}$. For a better approximation, use a larger number of points. We plot with a log scale on the y-axis since the piecewise exponential survival from `ppwe()` is piecewise linear on this scale.
We note that at the beginning of each rate period in the approximation the actual survival distribution and its approximation match exactly as indicated by the circles on the graph.


```{r}
#' Piecewise exponential cumulative distribution function
#'
#' \code{ppwe} computes the cumulative distribution function (CDF) or survival rate
#' for a piecewise exponential distribution.
#' @param x times at which distribution is to be computed.
#' @param failRates Piecewise constant failure rates in `rate`,
#' `duration` for each piecewise constant failure rate period.
#' @param lower.tail Indicator of whether lower (TRUE) or upper tail (FALSE; default)
#' of CDF is to be computed.
#' @details
#' Suppose \eqn{\lambda_i} is the failure rate in the interval \eqn{(t_{i-1},t_i], i=1,2,\ldots,M} where
#' \eqn{0=t_0<t_i\ldots,t_M=\infty}. The cumulative hazard function at an arbitrary time \eqn{t>0} is then:
#'
#' \deqn{\Lambda(t)=\sum_{i=1}^M \delta(t\le t_i)(\min(t,t_i)-t_{i-1})\lambda_i.}
#' The survival at time \eqn{t} is then
#' \deqn{S(t)=\exp(-\Lambda(t)).}
#' @section Specification:
#' \if{latex}{
#'  \itemize{
#'    \item Validate if input enrollment rate is a strictly increasing non-negative numeric vector.
#'    \item Validate if input failure rate is of type data.frame.
#'    \item Validate if input failure rate contains duration column.
#'    \item Validate if input failure rate contains rate column.
#'    \item Validate if input lower.tail is logical.
#'    \item Convert rates to step function.
#'    \item Add times where rates change to enrollment rates.
#'    \item Make a tibble of the input time points x, duration, hazard rates at points,
#'    cumulative hazard and survival.
#'    \item Extract the expected cumulative or survival of piecewise exponential distribution.
#'    \item If input lower.tail is true, return the cdf, else return the survival for \code{ppwe}
#'   }
#' }
#' \if{html}{The contents of this section are shown in PDF user manual only.}
#' @return A vector with cumulative distribution function or survival values
#' @examples
#' # Example: default
#' ppwe(seq(0:10))
#' # Example: plot a survival function with 2 different sets of time values
#' # to demonstrate plot precision corresponding to input parameters.
#' fr <- tibble::tibble(duration=c(3,3,1),rate=c(.2,.1,.005))
#' Time <- seq(0,10,10/pi)
#' Survival <-  ppwe(Time,fr)
#' plot(Time,Survival,type="l",ylim=c(0,1))
#' Time <- seq(0,10,.25)
#' Survival <-  ppwe(Time,fr)
#' lines(Time,Survival,col=2)
#' @noRd
ppwe <- function(x = 0:20,
                failRates=tibble::tibble(duration=c(3,100),
                                         rate=log(2)/c(9,18)),
                lower.tail=FALSE
){
# check input values
  # check input enrollment rate assumptions
  if(!is.numeric(x)){stop("gsDesign2: x in `ppwe()` must be a strictly increasing non-negative numeric vector")}
  if(!min(x) >= 0){stop("gsDesign2: x in `ppwe()` must be a strictly increasing non-negative numeric vector")}
  if(!min(x[x>0] - lag(x[x>0],default=0)) > 0){stop("gsDesign2: x in `ppwe()` must be a strictly increasing non-negative numeric vector")}

  # check input failure rate assumptions
  if(!is.data.frame(failRates)){stop("gsDesign2: failRates in `ppwe()` must be a data.frame")}
  if(!max(names(failRates)=="duration") == 1){stop("gsDesign2: failRates in `ppwe()` column names must contain duration")}
  if(!max(names(failRates)=="rate") == 1){stop("gsDesign2: failRates in `ppwe()` column names must contain rate")}

  # check lower.tail
  if(!is.logical(lower.tail)){stop("gsDesign2: lower.tail in `ppwe()` must be logical")}

# convert rates to step function
  ratefn <- stepfun(x=cumsum(failRates$duration),
                    y=c(failRates$rate,last(failRates$rate)),
                    right=TRUE)
# add times where rates change to failRates
  xvals <- sort(unique(c(x,cumsum(failRates$duration))))
# make a tibble
  xx <- tibble::tibble(x=xvals,
                       duration= xvals - lag(xvals,default = 0),
                       h=ratefn(xvals), # hazard rates at points (right continuous)
                       H=cumsum(h*duration), # cumulative hazard
                       survival=exp(-H) # survival
                       )
# return survival or cdf
  ind <- !is.na(match(xx$x,x))
  survival <- as.numeric(xx$survival[ind])
  if(lower.tail){
    return(1-survival)}else{
    return(survival)}
}
```

```{r, fig.width=6.5, fig.height=4}
# Use a large number of points to plot lognormal survival
times <- seq(0, 12, .025)

plot(times, plnorm(times, meanlog = 0, sdlog = 2, lower.tail = FALSE),
  log = "y", type = "l",
  main = "Lognormal Distribution vs. Piecewise Approximation", yaxt = "n",
  ylab = "log(Survival)", col = 1)

# Now plot the pieceise approximation using the 7-point approximation from above
lines(times, ppwe(x = times, failRates = lnormRates), col = 2)
# Finally, add point markers at the points used in the approximation
points(x = c(0:6), plnorm(c(0:6), meanlog = 0, sdlog = 2, lower.tail = FALSE), col = 1)
text(x = c(5, 5), y = c(.5, .4), labels = c("Log-normal", "Piecewise Approximation (7 pts)"), col = 1:2, pos = 4)
```

We considered the lognormal distribution due to the flexibility it allows for hazard rates over time; see, for example, [Wikipedia](https://en.wikipedia.org/wiki/Log-normal_distribution). 

## Poisson mixture model

We consider a Poisson mixture model to incorporate a cure model into sample size planning.
The form of the survival function for this is

$$S(t)=\exp(-\theta F_0(t))$$
for $t\ge 0$ where $F_0(t)$ is a continuous cumulative distribution function for a non-negative random variable with $F_0(0)=0$ and $F_0(t)\uparrow 1$ as $t\uparrow \infty$.
We note that as $t\uparrow \infty$, $S(t)\downarrow \exp(-\theta)=c$ where we will refer to $c$ as the cure rate.
The function `pPM()` assumes $F_0(t)=1-\exp(-\lambda t)$ is an exponential cumulative distribution function resulting in the survival distribution for $t\ge 0$:

$$S(t; \theta, \lambda) = \exp(-\theta(1-\exp(-\lambda t))).$$
Note that we set the default of `lower.tail=FALSE` so that the survival function computation is the default:

```{r}
pPM <- function(x, theta, lambda, lower.tail = FALSE) {
  exp(-theta * (1 - exp(-lambda * x)))
}
```

We plot this with $\lambda = \log(2) / 10$ to make $F_0(t)$ an exponential distribution with a median of 10.
We set $\theta = -\log(.4)$ to obtain a cure rate of 0.4. we then overlay with the piecewise exponential approximation.

```{r, fig.width=6.5, fig.height=4}
lambda <- log(2) / 10
theta <- -log(.4)
times <- 0:40
plot(times, pPM(times, theta, lambda), type = "l", ylab = "Survival", xlab = "Time", log = "y")

# Now compute piecewise expoential approximation
x <- seq(8, 40, 8)
pmRates <- s2pwe(
  times = x,
  survival = pPM(x, theta = theta, lambda = lambda))

# Now plot the pieceise approximation using the 7-point approximation from above
lines(c(0, x), ppwe(x = c(0, x), failRates = pmRates), col = 2)
points(c(0, x), pPM(c(0, x), theta, lambda))
```

We note that two different $\theta$ values provide a proportional hazards model in that the ratio of cumulative hazard function $H(t; \theta, \lambda) = \theta\exp(-\lambda t)$ is constant:

$$\frac{\log(S(t; \theta_1, \lambda))}{\log(S(t; \theta_2, \lambda))} = \theta_1/\theta_2.$$

For a given $\theta$ value we can compute $\lambda$ to provide a survival rate $c_1 > \exp(-\theta)$ at an arbitrary time $t_1>0$ by setting:

$$\lambda = -\log\left(\frac{\theta - \log(c_1)}{\theta}\right)/t_1.$$

We compute $\theta$ and $\lambda$ values with a cure rate of 0.4 and a survival rate of 0.6 at 30 months:

```{r}
theta <- -log(0.4)
lambda <- -log((theta + log(.6)) / theta) / 30
```

We confirm the survival at time 30:

```{r}
pPM(30, theta, lambda)
```