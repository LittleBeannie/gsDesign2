---
title: "Check gs_power_npe"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    highlight: "textmate"
    css: "custom.css"
bibliography: "ggsd.bib"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{What the Vignette Does (Title Case)}
  
---

```{r, echo=FALSE, message=FALSE}
library(gt)
library(dplyr)
library(tibble)
library(testthat)
library(gsDesign)
#library(gsDesign2)
devtools::load_all()
```


# Test 2: compare with `gsDesign` under information-based design

Information-based design is useful when testing for a natural parameter $\delta$ (e.g., treatment difference on a relevant scale such as risk difference) where the variance of the estimate of $\delta$ is unknown. 
The basic *canonical form* of @JTBook represents information-based design, so it is a particularly simple way to check corresponding basic calculations for sample size, bounds and power in `gs_power_npe()` and `gs_design_npe()`.

## Step 1: set the design assumptions

```{r}
k <- 2           # Number of analyses
test.type <- 4
alpha <- 0.025   # 1-sided Type I error
beta <- 0.15     # Type 2 error (1 - targeted power)
astar <- .1
timing <- 0.4    # Timing (information fraction) at interim analyses
sfu <- sfHSD     # Efficacy bound spending function
sfupar <- -1     # Upper bound spending function parameters, if any
sfl <- sfLDPocock# Lower bound spending function, if used (test.type > 2)
sflpar <- 0      # Lower bound spending function parameters, if any
delta <- 0.1     # Natural parameter difference (assumed value - H0 value)
delta1 <- 0.1    # Natural parameter assumed value
delta0 <- 0      # Natural parameter difference under H0
endpoint <- 'info'
n.fix <- 0
```

## Step 2: derive `gsDesign`

```{r}
x <- gsDesign(k = k,
              test.type = test.type,
              alpha = alpha,
              beta = beta,
              astar = astar,
              timing = timing,
              sfu = sfu,
              sfupar = sfupar,
              sfl = sfl,
              sflpar = sflpar,
              delta = delta,
              delta1 = delta1,
              delta0 = delta0,
              endpoint = endpoint,
              n.fix = n.fix)
x1 <- gsBoundSummary(x, Nname = "Information", digits = 7, ddigits = 7, tdigits = 7) 
```

## Step 3: derive gsdmvn `gs_design_npe`

```{r, eval=FALSE}
x2 <- gs_design_npe(theta = delta, info = c(timing, 1), info0 = NULL, alpha = alpha, beta = beta,
                   upper = gs_spending_bound, 
                   upar = list(par = list(sf = sfu, total_spend = alpha, param = sfupar, timing = NULL)),
                   lower = gs_spending_bound, 
                   lpar = list(par = list(sf = sfl, total_spend = beta, param = sflpar, timing = NULL)))
```

## Step 4: compare

```{r, eval=FALSE}
ans <- tibble(method = c("gsDesign", "gs_design_npe"),
       `Z of upper bound at IA` = c(x1$Efficacy[x1$Value == "Z"][1], 
                                    x2 %>% filter(Bound == "Upper", Analysis == 1) %>% select(Z)),
       `Z of upper bound at FA` = c(x1$Efficacy[x1$Value == "Z"][2], 
                                    x2 %>% filter(Bound == "Upper", Analysis == 2) %>% select(Z)),
       `Z of lower bound at IA` = c(x1$Futility[x1$Value == "Z"][1], 
                                    x2 %>% filter(Bound == "Lower", Analysis == 1) %>% select(Z)),
       `Z of lower bound at FA` = c(x1$Futility[x1$Value == "Z"][2], 
                                    x2 %>% filter(Bound == "Lower", Analysis == 2) %>% select(Z)),
       `prob to cross upper bound at IA under H0` = c(x$upper$prob[1, 1], 
                                                      x2 %>% filter(Bound == "Upper", Analysis == 1) %>% select(Probability0) %>% unlist() %>% as.numeric()),
       `prob to cross upper bound at IA under H1` = c(x$upper$prob[1, 2], 
                                                      x2 %>% filter(Bound == "Upper", Analysis == 1) %>% select(Probability) %>% unlist() %>% as.numeric()),
       `prob to cross upper bound at FA under H0` = c(sum(x$upper$prob[, 1]),
                                                      x2 %>% filter(Bound == "Upper", Analysis == 2) %>% select(Probability0) %>% unlist() %>% as.numeric()),
       `prob to cross upper bound at FA under H1` = c(sum(x$upper$prob[, 2]),
                                                      x2 %>% filter(Bound == "Upper", Analysis == 2) %>% select(Probability) %>% unlist() %>% as.numeric()),
       `prob to cross lower bound at IA under H0` = c(x$lower$prob[1, 1], 
                                                      x2 %>% filter(Bound == "Lower", Analysis == 1) %>% select(Probability0) %>% unlist() %>% as.numeric()),
       `prob to cross lower bound at IA under H1` = c(x$lower$prob[1, 2], 
                                                      x2 %>% filter(Bound == "Lower", Analysis == 1) %>% select(Probability) %>% unlist() %>% as.numeric()),
       `prob to cross lower bound at FA under H0` = c(sum(x$lower$prob[, 1]),
                                                      x2 %>% filter(Bound == "Lower", Analysis == 2) %>% select(Probability0) %>% unlist() %>% as.numeric()),
       `prob to cross lower bound at FA under H1` = c(sum(x$lower$prob[, 2]),
                                                      x2 %>% filter(Bound == "Lower", Analysis == 2) %>% select(Probability) %>% unlist() %>% as.numeric())
       ) %>% t() %>% as.data.frame()

tibble(`What to compare` = row.names(ans)[-1],
       gsDesign = ans$V1[-1],
       gs_design_npe = ans$V2[-1]) %>% gt()
```