---
title: "Check gs_power_npe"
output:
  rmarkdown::html_document:
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: true
    highlight: "textmate"
    css: "custom.css"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{What the Vignette Does (Title Case)}
---

```{r, echo=FALSE, message=FALSE}
library(gt)
library(dplyr)
library(tibble)
library(testthat)
devtools::load_all()
```


# Test 1: examples from spec

## Default
The default of `gs_power_npe` is a single analysis with type I error controlled.
```{r}
x1 <- gs_power_npe(theta = 0) %>% filter(Bound == "Upper")
x2 <- gsDesign2:::gs_power_npe_(theta = 0) %>% filter(Bound == "Upper")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  mutate(`Computated from` = c("new version", "old version")) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```

## Fixed bound
```{r}
x1 <- gs_power_npe(theta = c(.1, .2, .3),
                   info = (1:3) * 40,
                   upper = gs_b,
                   upar = list(par = gsDesign::gsDesign(k = 3,sfu = gsDesign::sfLDOF)$upper$bound),
                   lower = gs_b,
                   lpar = list(par = c(-1, 0, 0))) %>% mutate(`Computated from` = "new version")

x2 <- gsDesign2:::gs_power_npe_(theta = c(.1, .2, .3),
                                info = (1:3) * 40,
                                upper = gs_b,
                                upar = gsDesign::gsDesign(k = 3,sfu = gsDesign::sfLDOF)$upper$bound,
                                lower = gs_b,
                                lpar = c(-1, 0, 0)) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```

## Same fixed efficacy bounds, no futility bound (i.e., non-binding bound), null hypothesis
```{r}
x1 <- gs_power_npe(theta = rep(0, 3),
                   info = (1:3) * 40,
                   upar = list(par = gsDesign::gsDesign(k = 3,sfu = gsDesign::sfLDOF)$upper$bound),
                   lpar = list(par = rep(-Inf, 3))) %>% mutate(`Computated from` = "new version")

x2 <- gsDesign2:::gs_power_npe_(theta = rep(0, 3),
                                info = (1:3) * 40,
                                upar = gsDesign::gsDesign(k = 3,sfu = gsDesign::sfLDOF)$upper$bound,
                                lpar = rep(-Inf, 3)) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```


## Fixed bound with futility only at analysis 1; efficacy only at analyses 2, 3
```{r}
x1 <- gs_power_npe(theta = c(.1, .2, .3),
                   info = (1:3) * 40,
                   upper = gs_b,
                   upar = list(par = c(Inf, 3, 2)),
                   lower = gs_b,
                   lpar = list(par = c(qnorm(.1), -Inf, -Inf))) %>% mutate(`Computated from` = "new version")

x2 <- gsDesign2:::gs_power_npe_(theta = c(.1, .2, .3),
                                info = (1:3) * 40,
                                upper = gs_b,
                                upar = c(Inf, 3, 2),
                                lower = gs_b,
                                lpar = c(qnorm(.1), -Inf, -Inf)) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```

## Spending function bounds
```{r}
# Lower spending based on non-zero effect
x1 <- gs_power_npe(theta = c(.1, .2, .3),
                   info = (1:3) * 40,
                   upper = gs_spending_bound,
                   upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
                   lower = gs_spending_bound,
                   lpar = list(par = list(sf = gsDesign::sfHSD, total_spend = 0.1, param = -1, timing = NULL))) %>% mutate(`Computated from` = "new version")

x2 <- gsDesign2:::gs_power_npe_(theta = c(.1, .2, .3),
                                info = (1:3) * 40,
                                upper = gs_spending_bound,
                                upar = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
                                lower = gs_spending_bound,
                                lpar = list(sf = gsDesign::sfHSD, total_spend = 0.1, param = -1, timing = NULL)) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```

## Same bounds, but power under different theta
```{r}
x1 <- gs_power_npe(theta = c(.15, .25, .35),
                   info = (1:3) * 40,
                   upper = gs_spending_bound,
                   upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
                   lower = gs_spending_bound,
                   lpar = list(par = list(sf = gsDesign::sfHSD, total_spend = 0.1, param = -1, timing = NULL))) %>% mutate(`Computated from` = "new version")

x2 <- gsDesign2:::gs_power_npe_(theta = c(.15, .25, .35),
                                info = (1:3) * 40,
                                upper = gs_spending_bound,
                                upar = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
                                lower = gs_spending_bound,
                                lpar = list(sf = gsDesign::sfHSD, total_spend = 0.1, param = -1, timing = NULL)) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```

## Two-sided symmetric spend, O'Brien-Fleming spending
Typically, 2-sided bounds are binding
```{r, eval=FALSE}
x1 <- gs_power_npe(theta = rep(0, 3),
                   info = (1:3) * 40,
                   binding = TRUE,
                   upper = gs_spending_bound,
                   upar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)),
                   lower = gs_spending_bound,
                   lpar = list(par = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL))) %>% mutate(`Computated from` = "new version")

x2 <- gsDesign2:::gs_power_npe_(theta = rep(0, 3), 
                                info = (1:3) * 40,
                                binding = TRUE,
                                upper = gs_spending_bound,
                                upar = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL),
                                lower = gs_spending_bound,
                                lpar = list(sf = gsDesign::sfLDOF, total_spend = 0.025, param = NULL, timing = NULL)) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
x1 %>% 
  union_all(x2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```

## Re-use these bounds under alternate hypothesis
Always use binding = TRUE for power calculations
```{r}
xx1 <- gs_power_npe(theta = c(.1, .2, .3), 
                    info = (1:3) * 40,
                    binding = TRUE,
                    upar = list(par = (x1 %>% filter(Bound == "Upper"))$Z),
                    lpar = list(par = -(x1 %>% filter(Bound == "Upper"))$Z)) %>% mutate(`Computated from` = "new version")

xx2 <- gsDesign2:::gs_power_npe_(theta = c(.1, .2, .3), 
                                 info = (1:3) * 40,
                                 binding = TRUE,
                                 upar = (x1 %>% filter(Bound == "Upper"))$Z,
                                 lpar = -(x1 %>% filter(Bound == "Upper"))$Z) %>% mutate(`Computated from` = "old version")
```

```{r, echo=FALSE}
xx1 %>% 
  union_all(xx2) %>% 
  gt() %>% 
  tab_style(
    style = list(cell_fill(color = "#d3edeb")),
    locations = cells_body(rows = `Computated from` == "old version"))
```


